<!-- seasonality.html  | Panel 3: Trend Analizleri (KDS / 6â€“12 ay) -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trend Analizleri â€¢ StreamKDS</title>

  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Bu panel iÃ§in ufak layout dokunuÅŸlarÄ± (style.css'i bozmadan) -->
  <style>
    /* aynÄ± tasarÄ±m dili, sadece yerleÅŸim iyileÅŸtirme */
    .grid-1 { display:grid; grid-template-columns: 1fr; gap:16px; }
    .grid-2-eq { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:16px; }
    .grid-3-eq { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:16px; }
    .chart-wrap.xl { height: 360px; }
    .chart-wrap.lg { height: 300px; }
    .chart-wrap.md { height: 260px; }

    .kpi .kpi-value.big {
      font-size: 34px;
      letter-spacing: .2px;
    }

    .subtle-row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .chip{
      font-size:12px;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: rgba(0,0,0,.16);
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .chip b{ color: var(--text); font-weight:800; }

    .sim-wrap{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      margin-top: 12px;
    }
    .sim-panel{
      background: rgba(0,0,0,.14);
      border: 1px solid var(--stroke2);
      border-radius: var(--radius2);
      padding: 14px;
    }
    .sim-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 750;
    }
    .field select,
    .field input{
      background: rgba(0,0,0,.22);
      border: 1px solid var(--stroke2);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      outline: none;
    }
    .btn-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .btn{
      border: 1px solid var(--stroke2);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 750;
      transition:.15s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }
    .btn.primary{
      border-color: rgba(139,92,246,.35);
      background: rgba(139,92,246,.18);
    }
    .sim-results{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .result-card{
      border: 1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 14px;
    }
    .result-title{
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
    }
    .result-val{
      margin-top: 8px;
      font-size: 34px;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .result-sub{
      margin-top: 6px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.35;
    }

    @media (max-width: 1200px){
      .grid-2-eq{ grid-template-columns: 1fr; }
      .grid-3-eq{ grid-template-columns: 1fr; }
      .sim-wrap{ grid-template-columns: 1fr; }
      .sim-grid{ grid-template-columns: 1fr; }
      .chart-wrap.xl{ height: 320px; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- SIDEBAR (index ile aynÄ± dil) -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-dot"></div>
        <div>
          <div class="brand-title">KDS Dashboard</div>
          <div class="brand-sub">Film Platform AnalitiÄŸi</div>
        </div>
      </div>

      <nav class="nav">
        <a class="nav-item" href="anapanel.html">
          <span>Genel BakÄ±ÅŸ</span>
        </a>
        <a class="nav-item" href="behavior.html">
          <span>KullanÄ±cÄ±-Ä°Ã§erik Analizi</span>
        </a>
        <a class="nav-item active" href="seasonality.html">
          <span>Trend Analizleri</span>
        </a>
      </nav>

      <div class="sidebar-foot">
        <div class="pill">Sezonsal & Ã–zel DÃ¶nem Planlama</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- HEADER -->
      <header class="header">
        <div>
          <h1>Trend Analizleri</h1>
          <p>Ã–zel DÃ¶nemler & Sezonsal Ä°Ã§erik PlanÄ±</p>
        </div>

        <div class="header-actions">
          <div class="segmented" role="tablist" aria-label="YÄ±l filtresi">
            <button class="seg-btn active" data-year="all" type="button">TÃ¼mÃ¼</button>
            <button class="seg-btn" data-year="2023" type="button">2023</button>
            <button class="seg-btn" data-year="2024" type="button">2024</button>
            <button class="seg-btn" data-year="2025" type="button">2025</button>
          </div>
        </div>
      </header>

      <!-- KPI -->
      <section class="kpi-grid">
        <div class="card kpi">
          <div class="kpi-top">
            <div class="kpi-label">Pik Ay</div>
            <div class="kpi-badge">ðŸ“Œ</div>
          </div>
          <div class="kpi-value big" id="kpiPeakMonth">â€”</div>
          <div class="kpi-foot" id="kpiPeakMonthSub">â€”</div>
        </div>

        <div class="card kpi">
          <div class="kpi-top">
            <div class="kpi-label">Pikâ€“Dip FarkÄ±</div>
            <div class="kpi-badge">%</div>
          </div>
          <div class="kpi-value big" id="kpiPeakDip">â€”</div>
          <div class="kpi-foot">Sezonsal oynaklÄ±k</div>
        </div>

        <div class="card kpi">
          <div class="kpi-top">
            <div class="kpi-label">Ã–zel DÃ¶nem KatkÄ±sÄ±</div>
            <div class="kpi-badge">â˜…</div>
          </div>
          <div class="kpi-value big" id="kpiSpecialShare">â€”</div>
          <div class="kpi-foot">Yaz/KÄ±ÅŸ/Åžubat/AralÄ±k</div>
        </div>

        <div class="card kpi">
          <div class="kpi-top">
            <div class="kpi-label">En GÃ¼Ã§lÃ¼ DÃ¶nem TÃ¼rÃ¼</div>
            <div class="kpi-badge">ðŸŽ¬</div>
          </div>
          <div class="kpi-value big" id="kpiTopGenre">â€”</div>
          <div class="kpi-foot" id="kpiTopGenreSub">â€”</div>
        </div>
      </section>

      <!-- 1) AylÄ±k trend (senin gÃ¶rseldeki stile yakÄ±n) -->
      <section class="grid-1">
        <div class="card">
          <div class="card-head">
            <h2>AylÄ±k Ä°zlenme Trendi</h2>
            <div class="hint">Pik aylar iÅŸaretli â€¢ 6â€“12 ay stratejik planlama</div>
          </div>

          <div class="subtle-row" id="peakChips">
            <!-- JS ile doldurulacak: Pik: AÄŸustos (Yaz), Åžubat (Sevgililer GÃ¼nÃ¼)... -->
          </div>

          <div class="chart-wrap xl">
            <canvas id="chartMonthlyTrend"></canvas>
          </div>
        </div>
      </section>

      <!-- 2) Pik aylar kÄ±rÄ±lÄ±mÄ±: Tip & TÃ¼r (yan yana) -->
      <section class="grid-2-eq">
        <div class="card">
          <div class="card-head">
            <h2>Pik Aylarda Ä°Ã§erik Tipi KÄ±rÄ±lÄ±mÄ±</h2>
            <div class="hint">Film / Dizi / KÄ±sa Ä°Ã§erik / Animasyon</div>
          </div>
          <div class="chart-wrap lg">
            <canvas id="chartPeakByType"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <h2>Pik Aylarda Ä°Ã§erik TÃ¼rÃ¼ KÄ±rÄ±lÄ±mÄ±</h2>
            <div class="hint">12 tÃ¼r â€¢ Pik aylarda yatÄ±rÄ±m sinyali</div>
          </div>
          <div class="chart-wrap lg">
            <canvas id="chartPeakByGenre"></canvas>
          </div>
        </div>
      </section>

      <!-- 3) Ã–zel dÃ¶nemler: Tip + TÃ¼r aynÄ± anda (yan yana, anlaÅŸÄ±lÄ±r) -->
      <section class="grid-1">
        <div class="card">
          <div class="card-head">
            <h2>Ã–zel DÃ¶nemlerde Tip & TÃ¼r DaÄŸÄ±lÄ±mÄ±</h2>
            <div class="hint">Yaz / KÄ±ÅŸ / Sevgililer GÃ¼nÃ¼ / YÄ±lbaÅŸÄ± â€¢ Tek bakÄ±ÅŸta karar</div>
          </div>

          <div class="header-actions" style="justify-content:flex-start; margin: 4px 0 10px;">
            <div class="select-wrap">
              <label class="sr-only" for="specialSelect">Ã–zel dÃ¶nem</label>
              <select id="specialSelect">
                <option value="Sevgililer GÃ¼nÃ¼">Sevgililer GÃ¼nÃ¼</option>
                <option value="Yaz">Yaz</option>
                <option value="KÄ±ÅŸ">KÄ±ÅŸ</option>
                <option value="YÄ±lbaÅŸÄ±" selected>YÄ±lbaÅŸÄ±</option>
              </select>
            </div>
          </div>

          <section class="grid-2-eq">
            <div>
              <div class="hint" style="margin: 4px 0 10px;">Ã–zel dÃ¶nem â†’ Tip daÄŸÄ±lÄ±mÄ± (stacked)</div>
              <div class="chart-wrap md">
                <canvas id="chartSpecialTypeStack"></canvas>
              </div>
            </div>

            <div>
              <div class="hint" style="margin: 4px 0 10px;">SeÃ§ili dÃ¶nemde â†’ TÃ¼r yoÄŸunluÄŸu (yatay)</div>
              <div class="chart-wrap md">
                <canvas id="chartSpecialGenreBar"></canvas>
              </div>
            </div>
          </section>
        </div>
      </section>

      <!-- 4) SimÃ¼lasyon: dÃ¶nem + tip + tÃ¼r + yÃ¼zde + adet -->
      <section class="card simulator">
        <div class="card-head">
          <h2>Ã–zel DÃ¶nem Ä°Ã§erik YatÄ±rÄ±mÄ± SimÃ¼latÃ¶rÃ¼</h2>
          <div class="hint">SeÃ§ â†’ artÄ±ÅŸ (%) gir â†’ tahmini izlenme etkisini sayÄ±sal gÃ¶r</div>
        </div>

        <div class="sim-wrap">
          <div class="sim-panel">
            <div class="sim-grid">
              <div class="field">
                <label for="simPeriod">Ã–zel DÃ¶nem</label>
                <select id="simPeriod">
                  <option>Sevgililer GÃ¼nÃ¼</option>
                  <option>Yaz</option>
                  <option>KÄ±ÅŸ</option>
                  <option selected>YÄ±lbaÅŸÄ±</option>
                </select>
              </div>

              <div class="field">
                <label for="simType">Ä°Ã§erik Tipi</label>
                <select id="simType">
                  <option>Film</option>
                  <option selected>Dizi</option>
                  <option>KÄ±sa Ä°Ã§erik</option>
                  <option>Animasyon</option>
                </select>
              </div>

              <div class="field">
                <label for="simGenre">Ä°Ã§erik TÃ¼rÃ¼</label>
                <select id="simGenre">
                  <option>Aksiyon</option>
                  <option>Dram</option>
                  <option>Komedi</option>
                  <option>Bilim Kurgu</option>
                  <option>Gerilim</option>
                  <option>Korku</option>
                  <option selected>Romantik</option>
                  <option>SuÃ§</option>
                  <option>Macera</option>
                  <option>Fantastik</option>
                  <option>GenÃ§lik</option>
                  <option>Aile</option>
                </select>
              </div>

              <div class="field">
                <label for="simIncrease">Ä°Ã§erik ArtÄ±ÅŸÄ± (%)</label>
                <input id="simIncrease" type="number" min="0" max="60" step="1" value="10" />
              </div>

              <div class="field">
                <label for="simCount">Ek Ä°Ã§erik Adedi (opsiyonel)</label>
                <input id="simCount" type="number" min="0" max="50" step="1" value="6" />
              </div>

              <div class="field">
                <label>Not</label>
                <div class="chip">Model: <b>pikte geÃ§miÅŸ performans aÄŸÄ±rlÄ±ÄŸÄ±</b> + <b>tip/tÃ¼r katsayÄ±sÄ±</b></div>
              </div>
            </div>

            <div class="btn-row">
              <button class="btn primary" id="btnRunSim" type="button">SimÃ¼lasyonu Ã‡alÄ±ÅŸtÄ±r</button>
              <button class="btn" id="btnResetSim" type="button">SÄ±fÄ±rla</button>
            </div>
          </div>

          <div class="sim-results">
            <div class="result-card">
              <div class="result-title">Tahmini Ä°zlenme ArtÄ±ÅŸÄ±</div>
              <div class="result-val" id="simOutPct">+0%</div>
              <div class="result-sub" id="simOutPctSub">SeÃ§ili dÃ¶nem bazlÄ±</div>
            </div>

            <div class="result-card">
              <div class="result-title">Tahmini Ek Ä°zlenme (SayÄ±sal)</div>
              <div class="result-val" id="simOutAbs">+0</div>
              <div class="result-sub" id="simOutAbsSub">Baz dÃ¶nem izlenmesine gÃ¶re</div>
            </div>

            <div class="result-card">
              <div class="result-title">YatÄ±rÄ±m Notu</div>
              <div class="result-sub" id="simOutNote">â€”</div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    // ------------------------------
    // 0) Sabitler
    // ------------------------------
    const MONTHS_LONG = ["Ocak","Åžubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
    const MONTHS_SHORT = ["Oca","Åžub","Mar","Nis","May","Haz","Tem","AÄŸu","Eyl","Eki","Kas","Ara"];

    const TYPES = ["Film","Dizi","KÄ±sa Ä°Ã§erik","Animasyon"];
    const GENRES = ["Aksiyon","Dram","Komedi","Bilim Kurgu","Gerilim","Korku","Romantik","SuÃ§","Macera","Fantastik","GenÃ§lik","Aile"];

    const SPECIALS = ["Sevgililer GÃ¼nÃ¼","Yaz","KÄ±ÅŸ","YÄ±lbaÅŸÄ±"];

    // Ã–zel dÃ¶nem mapping (eksiksiz)
    const SPECIAL_MONTHS = {
      "Sevgililer GÃ¼nÃ¼": [1],        // Åžubat
      "Yaz": [6,7],                  // Temmuz, AÄŸustos
      "KÄ±ÅŸ": [0,1],                  // Ocak, Åžubat
      "YÄ±lbaÅŸÄ±": [11]                // AralÄ±k
    };

    // Renk paleti: sade & tutarlÄ± (karman Ã§orman yok)
    const C = {
      line: "rgba(139,92,246,1)",       // mor
      fill: "rgba(139,92,246,.18)",
      peak: "rgba(16, 185, 129, 1)",    // yeÅŸil nokta
      grid: "rgba(255,255,255,.08)",
      text: "rgba(255,255,255,.90)",
      dim: "rgba(255,255,255,.60)",

      type: {
        "Film": "rgba(59,130,246,1)",        // mavi
        "Dizi": "rgba(139,92,246,1)",        // mor
        "KÄ±sa Ä°Ã§erik": "rgba(245,158,11,1)", // amber
        "Animasyon": "rgba(34,197,94,1)"     // yeÅŸil
      },

      // tÃ¼rlerde aynÄ± ton ailesi (fazla renk patlamasÄ±n)
      genreBase: [
        "rgba(139,92,246,1)",
        "rgba(99,102,241,1)",
        "rgba(59,130,246,1)",
        "rgba(14,165,233,1)",
        "rgba(34,197,94,1)",
        "rgba(245,158,11,1)",
        "rgba(236,72,153,1)",
        "rgba(244,63,94,1)",
        "rgba(168,85,247,1)",
        "rgba(20,184,166,1)",
        "rgba(147,197,253,1)",
        "rgba(251,191,36,1)"
      ]
    };

    // Chart.js global
    Chart.defaults.color = C.text;
    Chart.defaults.borderColor = C.grid;
    Chart.defaults.font.family = 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    Chart.defaults.plugins.legend.labels.usePointStyle = true;

    // ------------------------------
    // 1) Demo veri (DB baÄŸlayÄ±nca burayÄ± API ile deÄŸiÅŸtirirsin)
    // ------------------------------
    const DATA = {
      2023: {
        monthlyViews: [3200, 4500, 3800, 3500, 3300, 3100, 5200, 5400, 4100, 3900, 4300, 6100],
        // month -> type shares (toplam 100)
        peakTypeSplit: {
          // ÅŸubat, tem, aÄŸu, ara odaklÄ± (diÄŸerleri gerekmez)
          1:  { "Film": 28, "Dizi": 44, "KÄ±sa Ä°Ã§erik": 18, "Animasyon": 10 },
          6:  { "Film": 24, "Dizi": 52, "KÄ±sa Ä°Ã§erik": 16, "Animasyon": 8  },
          7:  { "Film": 22, "Dizi": 54, "KÄ±sa Ä°Ã§erik": 16, "Animasyon": 8  },
          11: { "Film": 30, "Dizi": 42, "KÄ±sa Ä°Ã§erik": 12, "Animasyon": 16 }
        },
        peakGenreSplit: {
          1:  [8,14,10,6,7,5,20,6,7,6,6,5],   // Åžubat
          6:  [9,10,12,7,6,5,14,7,9,8,7,6],  // Temmuz
          7:  [8,9,12,8,6,5,13,7,10,9,7,6],  // AÄŸustos
          11: [6,12,10,6,5,4,11,5,7,14,6,14] // AralÄ±k (YÄ±lbaÅŸÄ±)
        }
      },

      2024: {
        monthlyViews: [3400, 4700, 4000, 3700, 3500, 3300, 5600, 5900, 4300, 4100, 4500, 6400],
        peakTypeSplit: {
          1:  { "Film": 26, "Dizi": 46, "KÄ±sa Ä°Ã§erik": 18, "Animasyon": 10 },
          6:  { "Film": 22, "Dizi": 56, "KÄ±sa Ä°Ã§erik": 14, "Animasyon": 8  },
          7:  { "Film": 21, "Dizi": 57, "KÄ±sa Ä°Ã§erik": 14, "Animasyon": 8  },
          11: { "Film": 29, "Dizi": 41, "KÄ±sa Ä°Ã§erik": 12, "Animasyon": 18 }
        },
        peakGenreSplit: {
          1:  [7,13,9,6,7,5,22,6,7,6,6,6],
          6:  [10,9,11,7,6,5,13,7,9,8,7,6],
          7:  [9,9,12,8,6,5,12,7,10,9,7,6],
          11: [6,11,9,6,5,4,10,5,7,15,6,16]
        }
      },

      2025: {
        monthlyViews: [3600, 4900, 4200, 3900, 3700, 3500, 5900, 6200, 4600, 4400, 4800, 6700],
        peakTypeSplit: {
          1:  { "Film": 25, "Dizi": 47, "KÄ±sa Ä°Ã§erik": 18, "Animasyon": 10 },
          6:  { "Film": 21, "Dizi": 58, "KÄ±sa Ä°Ã§erik": 13, "Animasyon": 8  },
          7:  { "Film": 20, "Dizi": 59, "KÄ±sa Ä°Ã§erik": 13, "Animasyon": 8  },
          11: { "Film": 28, "Dizi": 40, "KÄ±sa Ä°Ã§erik": 12, "Animasyon": 20 }
        },
        peakGenreSplit: {
          1:  [7,12,9,6,7,5,23,6,7,6,6,6],
          6:  [10,9,10,7,6,5,13,7,10,8,7,6],
          7:  [9,9,11,8,6,5,12,7,11,9,7,6],
          11: [6,10,9,6,5,4,10,5,7,15,6,17]
        }
      }
    };

    function mergeAllYears() {
      const years = [2023,2024,2025];
      const sum = (arrs) => arrs[0].map((_,i)=> arrs.reduce((a,arr)=>a+arr[i],0));
      const monthlyViews = sum(years.map(y => DATA[y].monthlyViews));

      // all years iÃ§in type/genre split'te ortalama alalÄ±m (daha temiz)
      const avgType = (m) => {
        const out = {};
        TYPES.forEach(t => {
          out[t] = Math.round(years.reduce((a,y)=> a + (DATA[y].peakTypeSplit[m]?.[t] ?? 0), 0) / years.length);
        });
        // yuvarlama sapmasÄ±nÄ± dÃ¼zelt
        const s = TYPES.reduce((a,t)=>a+out[t],0);
        out["Dizi"] += (100 - s);
        return out;
      };

      const avgGenre = (m) => {
        const out = GENRES.map((_,i)=>
          Math.round(years.reduce((a,y)=> a + (DATA[y].peakGenreSplit[m]?.[i] ?? 0), 0) / years.length)
        );
        // toplamÄ± 100'e yaklaÅŸtÄ±r (son elemana dÃ¼zelt)
        const s = out.reduce((a,v)=>a+v,0);
        out[out.length-1] += (100 - s);
        return out;
      };

      return {
        monthlyViews,
        peakTypeSplit: { 1: avgType(1), 6: avgType(6), 7: avgType(7), 11: avgType(11) },
        peakGenreSplit: { 1: avgGenre(1), 6: avgGenre(6), 7: avgGenre(7), 11: avgGenre(11) }
      };
    }

    // ------------------------------
    // 2) State & Helpers
    // ------------------------------
    let activeYear = "all";

    function getState(yearKey){
      if(yearKey === "all") return mergeAllYears();
      return DATA[+yearKey];
    }

    function maxIndex(arr){
      let mi = 0;
      for(let i=1;i<arr.length;i++) if(arr[i] > arr[mi]) mi=i;
      return mi;
    }
    function minIndex(arr){
      let mi = 0;
      for(let i=1;i<arr.length;i++) if(arr[i] < arr[mi]) mi=i;
      return mi;
    }

    function pct(n){ return (n>=0?"+":"") + n.toFixed(0) + "%"; }

    // Pik aylarÄ± seÃ§: en yÃ¼ksek 3 ay (KDS iÃ§in yeterli)
    function getTopKMonths(monthlyViews, k=3){
      const idx = monthlyViews.map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v).slice(0,k).map(o=>o.i);
      idx.sort((a,b)=>a-b);
      return idx;
    }

    function monthToSpecialName(mIndex){
      if(mIndex === 1) return "Sevgililer GÃ¼nÃ¼"; // Åžubat
      if(mIndex === 11) return "YÄ±lbaÅŸÄ±";        // AralÄ±k
      if(mIndex === 6 || mIndex === 7) return "Yaz"; // Tem/AÄŸu
      if(mIndex === 0) return "KÄ±ÅŸ";
      return "";
    }

    function buildPeakChips(topMonths){
      const wrap = document.getElementById("peakChips");
      wrap.innerHTML = "";
      topMonths.forEach(m => {
        const sp = monthToSpecialName(m);
        const el = document.createElement("div");
        el.className = "chip";
        el.innerHTML = `Pik: <b>${MONTHS_LONG[m]}</b>` + (sp ? ` â€¢ <span>${sp}</span>` : "");
        wrap.appendChild(el);
      });
    }

    // Ã–zel dÃ¶nem izlenmesi: ilgili aylarÄ±n toplamÄ±
    function specialTotalViews(state, period){
      const months = SPECIAL_MONTHS[period] || [];
      const sum = months.reduce((a,m)=> a + state.monthlyViews[m], 0);
      return sum;
    }

    // Ã–zel dÃ¶nem genre daÄŸÄ±lÄ±mÄ±nÄ± (100'lÃ¼k) hesapla: ilgili aylarÄ±n genre split ortalamasÄ±
    function specialGenreDist(state, period){
      const months = SPECIAL_MONTHS[period] || [];
      const lists = months.map(m => state.peakGenreSplit[m] || GENRES.map(_=>0));
      if(!lists.length) return GENRES.map(_=>0);

      const avg = GENRES.map((_,i)=> Math.round(lists.reduce((a,arr)=>a+arr[i],0) / lists.length));
      const s = avg.reduce((a,v)=>a+v,0);
      avg[avg.length-1] += (100 - s);
      return avg;
    }

    // Ã–zel dÃ¶nem type daÄŸÄ±lÄ±mÄ± (100'lÃ¼k)
    function specialTypeDist(state, period){
      const months = SPECIAL_MONTHS[period] || [];
      const dist = {};
      TYPES.forEach(t => dist[t]=0);

      if(!months.length) return dist;

      months.forEach(m => {
        const s = state.peakTypeSplit[m];
        if(s) TYPES.forEach(t => dist[t]+=s[t]);
      });

      TYPES.forEach(t => dist[t] = Math.round(dist[t] / months.length));
      const s = TYPES.reduce((a,t)=>a+dist[t],0);
      dist["Dizi"] += (100 - s);
      return dist;
    }

    // ------------------------------
    // 3) Charts
    // ------------------------------
    let chartMonthlyTrend, chartPeakByType, chartPeakByGenre, chartSpecialTypeStack, chartSpecialGenreBar;

    const baseGridScales = {
      x: { grid: { color: C.grid }, ticks: { color: C.dim } },
      y: { grid: { color: C.grid }, ticks: { color: C.dim }, beginAtZero: true }
    };

    function destroyAll(){
      [chartMonthlyTrend, chartPeakByType, chartPeakByGenre, chartSpecialTypeStack, chartSpecialGenreBar]
        .forEach(ch => ch && ch.destroy());
    }

    function renderMonthlyTrend(state){
      const topMonths = getTopKMonths(state.monthlyViews, 3);
      buildPeakChips(topMonths);

      const peakPointRadius = state.monthlyViews.map((_,i)=> topMonths.includes(i) ? 7 : 3);
      const peakPointBg = state.monthlyViews.map((_,i)=> topMonths.includes(i) ? C.peak : C.line);
      const peakPointBorder = state.monthlyViews.map((_,i)=> topMonths.includes(i) ? "rgba(255,255,255,.95)" : "rgba(255,255,255,.15)");
      const peakPointBorderW = state.monthlyViews.map((_,i)=> topMonths.includes(i) ? 3 : 1);

      const ctx = document.getElementById("chartMonthlyTrend");

      chartMonthlyTrend = new Chart(ctx, {
        type: "line",
        data: {
          labels: MONTHS_SHORT,
          datasets: [{
            label: "Ä°zlenme",
            data: state.monthlyViews,
            borderColor: C.line,
            backgroundColor: C.fill,
            tension: 0.35,
            pointRadius: peakPointRadius,
            pointHoverRadius: 8,
            pointBackgroundColor: peakPointBg,
            pointBorderColor: peakPointBorder,
            pointBorderWidth: peakPointBorderW,
            fill: true
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins: {
            legend: { display:false },
            tooltip: {
              callbacks: {
                title: (items) => {
                  const idx = items[0].dataIndex;
                  const sp = monthToSpecialName(idx);
                  return sp ? `${MONTHS_LONG[idx]} â€¢ ${sp}` : MONTHS_LONG[idx];
                }
              }
            }
          },
          scales: {
            x: baseGridScales.x,
            y: {
              ...baseGridScales.y,
              ticks: { color: C.dim },
              suggestedMax: Math.max(...state.monthlyViews) * 1.15
            }
          }
        }
      });

      return topMonths;
    }

    function renderPeakByType(state, topMonths){
      const months = topMonths.length ? topMonths : [1,7,11];
      const labels = months.map(m => {
        const sp = monthToSpecialName(m);
        return sp ? `${MONTHS_SHORT[m]} (${sp})` : MONTHS_SHORT[m];
      });

      const datasets = TYPES.map(t => ({
        label: t,
        data: months.map(m => (state.peakTypeSplit[m]?.[t] ?? 0)),
        backgroundColor: C.type[t],
        borderRadius: 10
      }));

      const ctx = document.getElementById("chartPeakByType");
      chartPeakByType = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins: {
            legend: { position:"top" },
            tooltip: {
              callbacks: {
                label: (item) => `${item.dataset.label}: ${item.formattedValue}%`
              }
            }
          },
          scales: {
            x: baseGridScales.x,
            y: { ...baseGridScales.y, max: 100, ticks: { color: C.dim, callback: (v)=> v + "%" } }
          }
        }
      });
    }

    function renderPeakByGenre(state, topMonths){
      // TÃ¼rlerde 12 bar: okunabilirlik iÃ§in yatay bar
      const months = topMonths.length ? topMonths : [1,7,11];

      // Her tÃ¼r iÃ§in (pik aylar ortalamasÄ±) -> tek grafikte anlaÅŸÄ±lÄ±r
      const avgGenre = GENRES.map((g,gi)=>{
        const vals = months.map(m => (state.peakGenreSplit[m]?.[gi] ?? 0));
        return Math.round(vals.reduce((a,v)=>a+v,0)/vals.length);
      });

      // bar sÄ±ralamasÄ±: bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe (okunmasÄ± kolay)
      const paired = GENRES.map((g,i)=>({g,val:avgGenre[i], color:C.genreBase[i]})).sort((a,b)=>b.val-a.val);

      const ctx = document.getElementById("chartPeakByGenre");
      chartPeakByGenre = new Chart(ctx, {
        type: "bar",
        data: {
          labels: paired.map(p=>p.g),
          datasets: [{
            label: "Pik Aylarda Pay",
            data: paired.map(p=>p.val),
            backgroundColor: paired.map(p=>p.color),
            borderRadius: 10
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          indexAxis: "y",
          plugins: {
            legend: { display:false },
            tooltip: {
              callbacks: {
                label: (item) => `${item.formattedValue}%`
              }
            }
          },
          scales: {
            x: { ...baseGridScales.x, max: 30, ticks: { color: C.dim, callback:(v)=>v+"%" } },
            y: { ...baseGridScales.y, ticks: { color: C.dim } }
          }
        }
      });
    }

    function renderSpecialCharts(state, period){
      // (A) Tip stacked
      const typeDist = specialTypeDist(state, period);
      const ctxA = document.getElementById("chartSpecialTypeStack");
      chartSpecialTypeStack = new Chart(ctxA, {
        type: "bar",
        data: {
          labels: [period],
          datasets: TYPES.map(t => ({
            label: t,
            data: [typeDist[t]],
            backgroundColor: C.type[t],
            borderRadius: 10
          }))
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins: { legend:{ position:"top" } },
          scales: {
            x: baseGridScales.x,
            y: { ...baseGridScales.y, stacked:true, max:100, ticks:{ color:C.dim, callback:(v)=>v+"%" } }
          }
        }
      });

      // (B) TÃ¼r yatay bar (seÃ§ili dÃ¶nemin tÃ¼r yoÄŸunluÄŸu)
      const gDist = specialGenreDist(state, period);
      const paired = GENRES.map((g,i)=>({g,val:gDist[i], color:C.genreBase[i]})).sort((a,b)=>b.val-a.val);

      const ctxB = document.getElementById("chartSpecialGenreBar");
      chartSpecialGenreBar = new Chart(ctxB, {
        type: "bar",
        data: {
          labels: paired.map(p=>p.g),
          datasets: [{
            label: "DÃ¶nem PayÄ±",
            data: paired.map(p=>p.val),
            backgroundColor: paired.map(p=>p.color),
            borderRadius: 10
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          indexAxis: "y",
          plugins: { legend:{ display:false } },
          scales: {
            x: { ...baseGridScales.x, max: 35, ticks:{ color:C.dim, callback:(v)=>v+"%" } },
            y: { ...baseGridScales.y, ticks:{ color:C.dim } }
          }
        }
      });
    }

    // ------------------------------
    // 4) KPI hesaplarÄ±
    // ------------------------------
    function updateKpis(state){
      const maxI = maxIndex(state.monthlyViews);
      const minI = minIndex(state.monthlyViews);
      const maxV = state.monthlyViews[maxI];
      const minV = state.monthlyViews[minI];

      document.getElementById("kpiPeakMonth").textContent = MONTHS_LONG[maxI];
      const sp = monthToSpecialName(maxI);
      document.getElementById("kpiPeakMonthSub").textContent = sp ? `${sp} etkisi gÃ¶rÃ¼lebilir` : `Pik ay (yÄ±l filtresine gÃ¶re)`;

      const diffPct = ((maxV - minV) / Math.max(1, minV)) * 100;
      document.getElementById("kpiPeakDip").textContent = diffPct.toFixed(0) + "%";

      // Ã¶zel dÃ¶nem katkÄ±sÄ±: (Åžubat + Temmuz + AÄŸustos + AralÄ±k + Ocak) / toplam
      const specialMonths = new Set([0,1,6,7,11]);
      const specialSum = state.monthlyViews.reduce((a,v,i)=> a + (specialMonths.has(i)?v:0), 0);
      const total = state.monthlyViews.reduce((a,v)=>a+v,0);
      const share = total ? (specialSum/total)*100 : 0;
      document.getElementById("kpiSpecialShare").textContent = share.toFixed(0) + "%";

      // en gÃ¼Ã§lÃ¼ dÃ¶nem tÃ¼rÃ¼: default "YÄ±lbaÅŸÄ±" iÃ§in top tÃ¼r
      const period = document.getElementById("specialSelect").value || "YÄ±lbaÅŸÄ±";
      const gDist = specialGenreDist(state, period);
      let best = 0;
      for(let i=1;i<gDist.length;i++) if(gDist[i] > gDist[best]) best = i;

      document.getElementById("kpiTopGenre").textContent = GENRES[best];
      document.getElementById("kpiTopGenreSub").textContent = `${period} dÃ¶neminde Ã¶ne Ã§Ä±kÄ±yor`;
    }

    // ------------------------------
    // 5) SimÃ¼lasyon (sayÄ±sal)
    // ------------------------------
    function runSimulation(state){
      const period = document.getElementById("simPeriod").value;
      const type = document.getElementById("simType").value;
      const genre = document.getElementById("simGenre").value;
      const inc = Math.max(0, +document.getElementById("simIncrease").value || 0);
      const count = Math.max(0, +document.getElementById("simCount").value || 0);

      // Baz: dÃ¶nemin toplam izlenmesi
      const base = specialTotalViews(state, period);

      // Tip aÄŸÄ±rlÄ±ÄŸÄ± (dÃ¶nem iÃ§inde tip payÄ±)
      const tDist = specialTypeDist(state, period);
      const typeShare = (tDist[type] ?? 0) / 100;

      // TÃ¼r aÄŸÄ±rlÄ±ÄŸÄ± (dÃ¶nem iÃ§inde tÃ¼r payÄ±)
      const gDist = specialGenreDist(state, period);
      const gIndex = GENRES.indexOf(genre);
      const genreShare = (gIndex >= 0 ? gDist[gIndex] : 0) / 100;

      // Basit ama KDSâ€™e uygun katsayÄ±: geÃ§miÅŸ paylar + artÄ±ÅŸ
      // iÃ§erik adedi opsiyonel: kÃ¼Ã§Ã¼k Ã§arpan (operasyonel deÄŸil, sadece yatÄ±rÄ±m bÃ¼yÃ¼klÃ¼ÄŸÃ¼ gÃ¶stergesi)
      const countBoost = Math.min(0.18, count * 0.01);   // 0..18%
      const incBoost = Math.min(0.60, inc / 100);        // 0..60%

      // Etki: (tip payÄ± * 0.55) + (tÃ¼r payÄ± * 0.45) temel, sonra artÄ±ÅŸ katsayÄ±larÄ±
      const baseWeight = (typeShare * 0.55) + (genreShare * 0.45);

      // Tahmini % artÄ±ÅŸ: artÄ±ÅŸ * aÄŸÄ±rlÄ±k * (1 + countBoost)
      const estPct = (incBoost * baseWeight) * (1 + countBoost);

      // SayÄ±sal ek izlenme
      const estAbs = Math.round(base * estPct);

      const pctOut = Math.round(estPct * 100);
      document.getElementById("simOutPct").textContent = (pctOut>=0?"+":"") + pctOut + "%";
      document.getElementById("simOutAbs").textContent = "+" + estAbs.toLocaleString("tr-TR");

      document.getElementById("simOutPctSub").textContent = `${period} â€¢ ${type} â€¢ ${genre}`;
      document.getElementById("simOutAbsSub").textContent = `Baz izlenme: ${base.toLocaleString("tr-TR")} (demo)`;

      // YatÄ±rÄ±m notu (Ã§ok kÄ±sa, anlaÅŸÄ±lÄ±r)
      let note = "";
      if (pctOut >= 8) note = "GÃ¼Ã§lÃ¼ sinyal: Bu Ã¶zel dÃ¶nemde seÃ§ilen tip+tÃ¼r geÃ§miÅŸte yÃ¼ksek pay almÄ±ÅŸ. YatÄ±rÄ±m artÄ±rÄ±mÄ± mantÄ±klÄ±.";
      else if (pctOut >= 4) note = "Orta sinyal: Etki var ama sÄ±nÄ±rlÄ±. ArtÄ±ÅŸÄ± yÃ¼kseltmeyi veya daha gÃ¼Ã§lÃ¼ tÃ¼r/tip kombinasyonunu test etmeyi dÃ¼ÅŸÃ¼n.";
      else note = "ZayÄ±f sinyal: SeÃ§ilen kombinasyon bu Ã¶zel dÃ¶nemde dÃ¼ÅŸÃ¼k pay alÄ±yor. TÃ¼r/tip deÄŸiÅŸtirerek yeniden dene.";
      document.getElementById("simOutNote").textContent = note;
    }

    function resetSimulation(){
      document.getElementById("simPeriod").value = "YÄ±lbaÅŸÄ±";
      document.getElementById("simType").value = "Dizi";
      document.getElementById("simGenre").value = "Romantik";
      document.getElementById("simIncrease").value = 10;
      document.getElementById("simCount").value = 6;
      document.getElementById("simOutPct").textContent = "+0%";
      document.getElementById("simOutAbs").textContent = "+0";
      document.getElementById("simOutPctSub").textContent = "SeÃ§ili dÃ¶nem bazlÄ±";
      document.getElementById("simOutAbsSub").textContent = "Baz dÃ¶nem izlenmesine gÃ¶re";
      document.getElementById("simOutNote").textContent = "â€”";
    }

    // ------------------------------
    // 6) Render pipeline
    // ------------------------------
    function refreshAll(){
      const state = getState(activeYear);
      destroyAll();

      const topMonths = renderMonthlyTrend(state);
      renderPeakByType(state, topMonths);
      renderPeakByGenre(state, topMonths);

      const period = document.getElementById("specialSelect").value || "YÄ±lbaÅŸÄ±";
      renderSpecialCharts(state, period);

      updateKpis(state);
      runSimulation(state);
    }

    // ------------------------------
    // 7) Events
    // ------------------------------
    document.querySelectorAll(".seg-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".seg-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        activeYear = btn.dataset.year;
        refreshAll();
      });
    });

    document.getElementById("specialSelect").addEventListener("change", () => {
      const state = getState(activeYear);
      // sadece Ã¶zel dÃ¶nem chartlarÄ±nÄ± yenile
      chartSpecialTypeStack && chartSpecialTypeStack.destroy();
      chartSpecialGenreBar && chartSpecialGenreBar.destroy();
      renderSpecialCharts(state, document.getElementById("specialSelect").value);
      updateKpis(state);
      // simÃ¼lasyonu da aynÄ± dÃ¶neme yaklaÅŸtÄ±ralÄ±m (kullanÄ±cÄ± isterse ayrÄ± seÃ§ebilir)
    });

    document.getElementById("btnRunSim").addEventListener("click", () => {
      runSimulation(getState(activeYear));
    });
    document.getElementById("btnResetSim").addEventListener("click", () => {
      resetSimulation();
      runSimulation(getState(activeYear));
    });

    // input deÄŸiÅŸtikÃ§e canlÄ± gÃ¼ncelle (KDS â€œÃ§evikâ€)
    ["simPeriod","simType","simGenre","simIncrease","simCount"].forEach(id => {
      document.getElementById(id).addEventListener("input", ()=> runSimulation(getState(activeYear)));
    });

    // initial
    resetSimulation();
    refreshAll();
  </script>
</body>
</html>  